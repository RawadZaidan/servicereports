{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="document-letterhead print-only">
    <img src="{% static 'img/medilab_logo.png' %}" alt="Medilab Logo" class="letterhead-logo">
    <img src="{% static 'img/iso_logo.png' %}" alt="ISO Certification" class="letterhead-logo">
</div>

<div class="report-page-header">
    <div class="report-title-section">
        <h1>
            Report #SR-{{ report.id }} 
            <span class="status-badge status-{{ report.status|lower }}">{{ report.status }}</span>
        </h1>
        <div class="report-meta">
            <span><i class="icon-user"></i> {{ report.engineer.get_full_name|default:report.engineer.username }} (Engineer)</span>
            <span><i class="icon-calendar"></i> {{ report.service_date|date:"M d, Y" }}</span>
            <span><i class="icon-clock"></i> {{ report.service_date|time:"H:i A" }}</span>
            {% if report.maintenance_request %}
            <span class="report-badge" style="background: #fef3c7; color: #92400e;">Linked to MR-{{ report.maintenance_request.id }}</span>
            {% endif %}
        </div>
    </div>
    <div class="report-actions">
        {% if report.status == 'Draft' %}
        <a href="{% url 'report_update' report.pk %}" class="btn btn-secondary">Edit Report</a>
        {% endif %}
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back</a>
        <button class="btn btn-primary" onclick="window.print()">Print</button>
    </div>
</div>

<div class="report-grid-layout">
    <div class="report-main-col grid-col-8">
        <!-- Client Details Section -->
        <div class="card" style="margin-bottom: 1rem;">
            <div class="card-title">Client Details</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div class="info-group">
                    <span class="info-label">Facility Name</span>
                    <div class="info-value">{{ report.client_name }}</div>
                </div>
                <div class="info-group">
                    <span class="info-label">Project Reference</span>
                    <div class="info-value">{{ report.project_reference|default:"N/A" }}</div>
                </div>
                <div class="info-group">
                    <span class="info-label">Location / Department</span>
                    <div class="info-value">{{ report.location }}</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="info-group">
                    <span class="info-label">Contact Person</span>
                    <div class="info-value">{{ report.client_representative_name }}</div>
                </div>
                {% if report.client_phone_number %}
                <div class="info-group">
                    <span class="info-label">Contact Phone</span>
                    <div class="info-value">{{ report.client_phone_number }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Service Info Section -->
        <div class="card" style="margin-bottom: 1rem;">
            <div class="card-title">Service Info</div>
            <div class="service-info-grid">
                <div class="info-group">
                    <span class="info-label">Service Type</span>
                    <div class="info-value">{{ report.service_type|default:"N/A" }}</div>
                </div>
                <div class="info-group">
                    <span class="info-label">Follow-up Required</span>
                    <div class="info-value">{{ report.follow_up_required|yesno:"Yes,No" }}</div>
                </div>
                {% if report.billing_category %}
                <div class="info-group">
                    <span class="info-label">Billing Category</span>
                    <div class="info-value">{{ report.billing_category }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Work Performed -->
        <div class="card" style="margin-bottom: 1rem;">
            <div class="card-title">Work Performed & Notes</div>
            <div class="content-block">
                <h4>Issue Description</h4>
                <p>{{ report.issue_description|linebreaksbr }}</p>
            </div>
            <div class="content-block">
                <h4>Detailed Work performed</h4>
                <p>{{ report.work_performed|linebreaksbr }}</p>
            </div>
            {% if report.parts_used %}
            <div class="content-block">
                <h4>Parts Replaced / Used</h4>
                <p style="background: #f8fafc; padding: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                    {{ report.parts_used|linebreaksbr }}
                </p>
            </div>
            {% endif %}
            <div class="content-block" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9;">
                <h4 style="color: #0f172a;">Final Outcome</h4>
                <p>{{ report.final_status|default:"N/A" }}</p>
            </div>
        </div>

        <!-- Attachments -->
        <div class="card">
            <div class="card-title">Service Attachments <span style="margin-left:auto; font-size:0.8rem; color:#94a3b8;">{{ report.images.count }} Images</span></div>
            <div class="photo-grid">
                {% for img in report.images.all %}
                    <a href="{{ img.image.url }}" target="_blank">
                        <img src="{{ img.image.url }}" class="photo-thumb" alt="Attachment">
                    </a>
                {% empty %}
                    <p class="text-muted">No photos attached.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar Column: Validation & Equipment -->
    <div class="report-sidebar-col grid-col-4">
        <!-- Client Validation Section -->
        <div class="card" style="margin-bottom: 1rem;">
            <div class="card-title">Client Validation</div>
            <div class="info-group">
                <span class="info-label">Signatory Name</span>
                <div class="info-value">{{ report.client_representative_name }}</div>
            </div>
            <div class="info-group">
                <span class="info-label">Date Signed</span>
                <div class="info-value">{{ report.service_date|date:"M d, Y" }}</div>
            </div>
            <div class="info-group">
                <span class="info-label">Signature</span>
                <div class="signature-box">
                    {% if report.client_signature %}
                        <img src="{{ report.client_signature.url }}" class="signature-img" alt="Signature">
                    {% else %}
                        <span style="color: #cbd5e1;">No signature</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Equipment Details Section -->
        <div class="card">
            <div class="card-title">Equipment Details</div>
            {% for item in report.items.all %}
            <div class="equipment-item-detail" {% if not forloop.last %}style="border-bottom: 1px solid #f1f5f9; margin-bottom: 0.5rem; padding-bottom: 0.5rem;"{% endif %}>
                <div class="info-group">
                    <span class="info-label">Product Name</span>
                    <div class="info-value" style="font-weight: 700; color: var(--primary-color);">{{ item.product.name }}</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div class="info-group">
                        <span class="info-label">Model</span>
                        <div class="info-value">{{ item.product.model }}</div>
                    </div>
                    <div class="info-group">
                        <span class="info-label">S/N</span>
                        <div class="info-value">{{ item.serial_number|default:item.product.serial_number|default:"N/A" }}</div>
                    </div>
                </div>
                {% if item.equipment_note %}
                <div class="info-group" style="background: #fdfce7; padding: 0.25rem; border-radius: 4px; margin-top: 0.25rem;">
                    <span class="info-label" style="color: #854d0e;">Note</span>
                    <div class="info-value" style="font-size: 0.85rem; color: #422006;">{{ item.equipment_note }}</div>
                </div>
                {% endif %}
            </div>
            {% empty %}
                <p class="text-muted">No equipment listed.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
